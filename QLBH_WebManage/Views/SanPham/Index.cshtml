
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-8 col-sm-6">
            <button type="button" class="btn btn-primary fs-5" data-bs-toggle="modal" data-bs-target="#exampleModal">
                Thêm
            </button>

        </div>
        <div class="col-4 col-sm-6 text-end">
            <div class="d-flex">
                <input class="form-control" type="text" placeholder="Tìm sản phẩm ..." aria-label="Search" id="txtSearch">
                <button class="btn btn-outline-warning" onclick="Search()"><i class="fa fa-search"></i></button>
                <button class="btn btn-outline-success" onclick="getDsSanPham()">Làm mới</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Thêm sản phẩm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-4">
                        <div class="mb-3">
                            <label for="txtMaKH" class="form-label">Mã sản phẩm</label>
                            <input type="text" class="form-control" id="txtMaSP" placeholder="Để trống ..." disabled>
                        </div>
                        <div class="mb-3">
                            <label for="txtTenKH" class="form-label">Tên sản phẩm</label>
                            <input type="text" class="form-control" id="txtTenSP">
                        </div>
                        <div class="mb-3">
                            <label for="txtTenKH" class="form-label">Đơn vị tính</label>
                            <input type="text" class="form-control" id="txtDVT">
                        </div>
                        <div class="mb-3">
                            <label for="txtTenKH" class="form-label">Đơn giá</label>
                            <input type="text" class="form-control" id="txtDonGia">
                        </div>
                        <div class="mb-3">
                            <label for="ddlMaLoai" class="form-label">Loại</label>
                            <select class="form-select" id="ddlMaLoai"></select>
                        </div>
                        <div class="mb-3">
                            <label for="ddlThuongHieu" class="form-label">Thương hiệu</label>
                            <select class="form-select" id="ddlThuongHieu"></select>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="mb-3">
                            <label for="txtSLX" class="form-label">Số lần xem</label>
                            <input type="text" class="form-control" id="txtSLX" value="0" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="txtKhuyenMai" class="form-label">Khuyến mãi</label>
                            <input type="text" class="form-control" id="txtKhuyenMai">
                        </div>
                        <div class="mb-3">
                            <label for="txtSL" class="form-label">Số lượng</label>
                            <input type="text" class="form-control" id="txtSL">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Tình trạng : <input type="checkbox" id="chkTrangThai"></label>
                        </div>

                        <div class="mb-3">
                            <label for="txtMoTa" class="form-label">Mô tả</label>
                            <input type="text" class="form-control" id="txtMoTa">
                        </div>
                        <div class="mb-3">
                            <label for="txtMoTaCT" class="form-label">Chi tiết SP: <textarea id="txtMoTaCT" class="form-control"></textarea></label>
                            <script>CKEDITOR.replace("txtMoTaCT");</script>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="mb-3">
                            <label>Chọn ảnh SEO</label>
                            <input type="file" class="form-control" id="uploadImageSEO" />
                            <div>
                                <img id="imageSeoPreview" />
                                <button class="btn btn-danger" onclick="RemoveProductImageSEO()">Hủy ảnh SEO</button>

                            </div>
                        </div>

                        <div class="mb-3">
                            <label>Chọn ảnh chi tiết</label>
                            <input type="file" class="form-control" id="uploadImage" multiple="multiple" />
                            <div class="mb-3">
                                <div id="dvPreview">
                                </div>
                                <div class="image-upload">
                                    <label for="fileaddMore"><i class="fa fa-plus"></i></label>
                                    <input type="file" class="form-control" id="fileaddMore" multiple="multiple" hidden />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="Insert()">Lưu</button>

                </div>
            </div>
        </div>
    </div>
</div>


<div id="dsSanPham" width="100%">

</div>

<div class="d-flex justify-content-center">
        <ul id="pagination-demo" class="pagination-x"></ul>
</div>

<script>
    jQuery(document).ready(function ($) {
        getDsSanPham();
        getDsThuongHieu();
        getDsLoaiSP();

        //Upload SEO image
        $('#uploadImageSEO').on('change', function () {
            var statusEditImg = 0;
            if (typeof (FileReader) != "undefined") {
                var dvPreview = $("#dvPreview");
                dvPreview.html("");
                var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.jpg|.jpeg|.gif|.png|.bmp)$/;
                var index = 0;
                $($(this)[0].files).each(function () {
                    var file = $(this);
                    if (regex.test(file[0].name.toLowerCase())) {
                        var reader = new FileReader();
                        reader.onload = function (e) {

                            /*Upload one image*/
                            $("#imageSeoPreview").attr("style", "height:250px;width: 250px");
                            $("#imageSeoPreview").attr("src", e.target.result);
                            statusEditImg = 1;

                            //Upload multi image
                            //var img = $("<img class='img_" + index + "'/> <span id='span_img_" + index + "'><a onclick='RemoveProductImage(" + index + ")' href='#'>Xóa</a></span> <br/>");
                            //img.attr("style", "height:250px;width: 250px");
                            //img.attr("src", e.target.result);
                            //console.log(e.target.result);
                            //dvPreview.append(img);
                            //index++;

                        }
                        reader.readAsDataURL(file[0]);
                    } else {
                        alert(file[0].name + " is not a valid image file.");
                        dvPreview.html("");
                        return false;
                    }

                });
            } else {
                alert("This browser does not support HTML5 FileReader.");
            }
        });

        //Upload detail image
        $('#uploadImage').on('change', function () {
            var statusEditImg = 0;
            if (typeof (FileReader) != "undefined") {
                var dvPreview = $("#dvPreview");
                dvPreview.html("");
                var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.jpg|.jpeg|.gif|.png|.bmp)$/;
                var index = 0;
                $($(this)[0].files).each(function () {
                    var file = $(this);
                    if (regex.test(file[0].name.toLowerCase())) {
                        var reader = new FileReader();
                        reader.onload = function (e) {

                            /*Upload one image*/
                            //$("#imagePreview").attr("src", e.target.result);
                            //statusEditImg = 1;

                            //Upload multi image
                            var img = $("<img class='img_" + index + "'/> <span id='span_img_" + index + "'><a onclick='RemoveProductImage(" + index + ")' href='#'>Xóa</a></span> <br/>");
                            img.attr("style", "height:250px;width: 250px");
                            img.attr("src", e.target.result);
                            console.log(e.target.result);
                            dvPreview.append(img);
                            index++;

                        }
                        reader.readAsDataURL(file[0]);
                    } else {
                        alert(file[0].name + " is not a valid image file.");
                        dvPreview.html("");
                        return false;
                    }

                });
            } else {
                alert("This browser does not support HTML5 FileReader.");
            }
        });

        $('#fileaddMore').on('change', function () {
            var dvPreview = $("#dvPreview");
            if (typeof (FileReader) != "undefined") {
                var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.jpg|.jpeg|.gif|.png|.bmp)$/;
                $($(this)[0].files).each(function () {
                    var file = $(this);

                    if (regex.test(file[0].name.toLowerCase())) {
                        var reader = new FileReader();
                        reader.onload = function (e) {

                            var count = $("#dvPreview img").length;
                            if (count != null && count != "") {
                                count = parseInt(count, 10) - 1;
                            }

                            var img = $("<img class='img_" + (parseInt(count, 10) + 1) + "'/> <span id='span_img_" + (parseInt(count, 10) + 1) + "'><a onclick='RemoveProductImage(" + (parseInt(count, 10) + 1) + ")' href='#'>Xóa</a></span> <br/>");
                            img.attr("style", "height:250px;width: 250px");
                            img.attr("src", e.target.result);
                            //  console.log(e.target.result);
                            dvPreview.append(img);
                            // $('#imgPreview').attr("src", e.target.result);

                        };
                        reader.readAsDataURL(file[0]);
                    } else {
                        alert(file[0].name + " không phải là file ảnh.");
                        dvPreview.html("");
                        return false;
                    }
                    return false;
                });
            } else {
                alert("This browser does not support HTML5 FileReader.");
            }
        });
    });

    var cookieToken = JSON.parse(Common.getCookie("ManagerShop_Cookies"));

    function RemoveProductImageSEO() {
        $("#imageSeoPreview").removeAttr("src");
    }

    var pageSize = 5;
    var pageIndex = 1;

    //Lấy sản phẩm
    function getDsSanPham() {

        var inputData = {
            TenSp: "",
            token: cookieToken.token,
            page: pageIndex,
            pageSize: pageSize
        };

        $.ajax({
            type: 'POST',
            url: "/SanPham/PartialIndex",
            data: inputData,
            success: function (data) {
                $('#dsSanPham').html(data);
                dataPaging('@ViewBag.TotalRow', function () {
                    getDsSanPham();
                });
            },
            error: function (data) {
                console.log("error:" + JSON.stringify(data));

            }

        });
    }

    //Phân trang
    function dataPaging(totalRow, callback) {

        var totalPage = Math.ceil(totalRow / pageSize);
        $('#pagination-demo').twbsPagination({
            totalPages: totalPage,
            visiblePages: 5,
            first: "Đầu",
            next: "Tiếp",
            last: "Cuối",
            prev: "Trước",
            onPageClick: function (event, page) {
                pageIndex = page;
                setTimeout(callback, 200);
            }
        });
    }

    //Lấy thương hiệu
    function getDsThuongHieu() {

        var inputData = {
            token: cookieToken.token
        };

        $.ajax({
            type: 'POST',
            url: "/SanPham/GetThuongHieu",
            data: inputData,
            success: function (data) {
                var html = "";
                var thuonghieu = data.result;
                if (data != null) {
                    $.each(data, function (index, thuonghieu) {
                        html += "<option value=\"" + thuonghieu.maTh + "\">" + thuonghieu.tenTh + "</option>"

                    })
                };
                $("#ddlThuongHieu").append(html);
            },
            error: function (data) {
                console.log("error:" + JSON.stringify(data));

            }

        });
    }

    //Lấy loại sp
    function getDsLoaiSP() {
        var inputData = {
            token: cookieToken.token
        };

        $.ajax({
            type: 'POST',
            url: "/SanPham/GetLoaiSP",
            data: inputData,
            success: function (data) {
                var html = "";
                var loaisp = data.result;
                if (data != null) {
                    $.each(data, function (index, loaisp) {
                        html += "<option value=\"" + loaisp.maLoai + "\">" + loaisp.tenLoaiSp + "</option>"

                    })
                };
                $("#ddlMaLoai").append(html);
            },
            error: function (data) {
                console.log("error:" + JSON.stringify(data));

            }

        });
    }

    function RemoveProductImage(index) {
        $("#dvPreview .img_" + index).remove();
        $("#dvPreview #span_img_" + index).remove();
    }

    function Insert() {
        var masp = $("#txtMaSP").val();
        var tensp = $("#txtTenSP").val();
        var dvt = $("#txtDVT").val();
        var dongia = $("#txtDonGia").val();
        var km = $("#txtKhuyenMai").val();
        var mota = $("#txtMoTa").val();
        var sl = $("#txtSL").val();
        var motact = CKEDITOR.instances['txtMoTaCT'].getData();

        var trangthai = true;
        if ($("#chkTrangThai").is(":checked")) {
            trangthai = true;
        }
        else {
            trangthai = false;
        }

        var maloai = $("#ddlMaLoai").val();
        var math = $("#ddlThuongHieu").val();

        //Upload seo img
        var imageBase64Seo = "";
        if (typeof ($("#imageSeoPreview").attr("src")) === 'undefined') {
            imageBase64Seo = "";
        }
        else {
            imageBase64Seo = $("#imageSeoPreview").attr("src");
            imageBase64Seo = imageBase64Seo.split(',')[1];
        }


        //Upload detail img
        var lstImageSrc = "";
        // Lấy tất cả cả thẻ img trong thẻ div có id là dvPreview

        $("#dvPreview img").each(function (index, item) {
            //lấy src của từng ảnh trong thẻ Div dvPreview
            var imageBase64 = item.src;
            if (imageBase64 != null || imageBase64 != "") {
                // Cắt bỏ đi data:image/jpeg;base64,
                imageBase64 = imageBase64.split(',')[1];
                lstImageSrc += imageBase64 + "_";
            }
            console.log(imageBase64);
        });
        // Cắt bỏ ký tự "_" ở cuối cùng

        console.log("lstImageSrc:" + lstImageSrc);

        if (lstImageSrc != null && lstImageSrc.length > 0) {
            lstImageSrc = lstImageSrc.substring(0, lstImageSrc.length - 1);
        }


        var inputData = {
            maSp: masp,
            tenSp: tensp,
            donViTinh: dvt,
            donGia: dongia,
            maLoai: maloai,
            maTh: math,
            seoImage: imageBase64Seo,
            image: lstImageSrc,
            moTa: mota,
            chiTietSp: motact,
            soLanXem: motact,
            giamGia: km,
            soLuong: sl,
            tinhTrang: trangthai,
            ngayThem: moment().format('YYYY-MM-DD HH:mm:ss')
        };

        $.ajax({
            type: 'POST',
            url: "/SanPham/SanPhamInsert",
            data: inputData,
            success: function (data) {
                var result = data.ResponseCode;
                if (result > 0) {
                    swal({
                        text: data.Description,
                        icon: "success",
                        button: "OK!",
                    });
                    getDsSanPham();
                    $(".modal-backdrop").remove();
                }
            },
            error: function (data) {
                console.log("error:" + JSON.stringify(data));

            }
        });
    }

    function Search() {
        var tensp = $("#txtSearch").val();
        tensp = tensp.trim();
        var searchData = {
            TenSp: tensp,
            token: cookieToken.token,
            page: pageIndex,
            pageSize: pageSize
        };

        $.ajax({
            type: "POST",
            url: "/SanPham/PartialIndex",
            data: searchData,
            success: function (data) {
                $("#dsSanPham").html(data);
                dataPaging('@ViewBag.TotalRow', function () {
                    getDsSanPham();
                });
            },
            error: function (data) {
                console.log("error:" + JSON.stringify(data));

            }
        });
    }
</script>
